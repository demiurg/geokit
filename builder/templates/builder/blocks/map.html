<div class="leaflet-map" id="map-{{ self.id }}"></div>

<script>
var map = L.map('map-{{ self.id}}');
{% if self.layer.bounds %}
map.fitBounds([
    [{{ self.layer.bounds.1 }}, {{ self.layer.bounds.0 }}],
    [{{ self.layer.bounds.3 }}, {{ self.layer.bounds.2 }}]
]);
{% endif %}

L.tileLayer('https://api.mapbox.com/v4/ags.map-g13j9y5m/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWdzIiwiYSI6IjgtUzZQc0EifQ.POMKf3yBYLNl0vz1YjQFZQ').addTo(map);

function getColor(value) {
    {% for color in self.color_ramp %}
    if (value >= {{ color.min_value }} && value <= {{ color.max_value }}) {
        return '{{ color.color }}';
    }
    {% endfor %}
}


var geojsonURL = '/expressions/evaluate/tile/{{ self.layer.name }}/{z}/{x}/{y}/{{ self.expression.id }}/';
var geojsonTileLayer = new L.TileLayer.GeoJSON(geojsonURL, {
    clipTiles: false,
    unique: function(feature) {
        return feature.id;
    }
}, {
    style: function(feature) {
        var featureColor = getColor(feature.properties.patchVal);

        return {
            "clickable": true,
            "fillColor": featureColor,
            "color": "#000",
            "weight": 1.0,
            "opacity": 0.3,
            "fillOpacity": 0.7
        };
    },
    onEachFeature: function(feature, layer) {
        if (feature.properties) {
            var popupString = '<div class="popup">' + feature.properties.patchVal + '</div>';
            layer.bindPopup(popupString);
        }
        layer.on('click', function() {
            console.log(feature);
        });
    }
});
map.addLayer(geojsonTileLayer);
</script>
