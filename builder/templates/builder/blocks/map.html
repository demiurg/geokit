<div class="leaflet-map" id="map-{{ self.id }}"></div>

<script>
var map = L.map('map-{{ self.id}}').setView([51, 13.738], 17);
{% comment %}
{% if self.layer.bounds %}
map.fitBounds([
    [{{ self.layer.bounds.1 }}, {{ self.layer.bounds.0 }}],
    [{{ self.layer.bounds.3 }}, {{ self.layer.bounds.2 }}]
]);
{% endif %}
{% endcomment %}

L.tileLayer('https://api.mapbox.com/v4/ags.map-g13j9y5m/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWdzIiwiYSI6IjgtUzZQc0EifQ.POMKf3yBYLNl0vz1YjQFZQ').addTo(map);

function getColor(value) {
    {% for color in self.color_ramp %}
    if (value >= {{ color.min_value }} && value <= {{ color.max_value }}) {
        return 'rgb(' + '{{ color.color }}' + ')';
    }
    {% endfor %}
}

var mvtURL = '/expressions/evaluate/{{ self.expression }}/tile/{{ self.layer.name }}/{z}/{x}/{y}/';
var config = {
    url: mvtURL,
    getIDForLayerFeature: function(feature) { return feature.properties.id; },
    style: function(feature) {
        var style = {};
        if ('expressionVal' in feature.properties) {
            style.color = getColor(feature.properties.expressionVal);
        }

        return style;
    }
};
var tiled = this.tiled = new L.TileLayer.MVTSource(config).addTo(map);
</script>
