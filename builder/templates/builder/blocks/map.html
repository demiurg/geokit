{% load geokit_blocks_tags %}

<div class="panel panel-default">
  <div class="panel-body">
    <div class="leaflet-map" id="map-{{ self.id }}"></div>
  </div>
</div>

<script>
var map = L.map('map-{{ self.id}}');
{% if self.layer.bounds %}
map.fitBounds([
    [{{ self.layer.bounds.1 }}, {{ self.layer.bounds.0 }}],
    [{{ self.layer.bounds.3 }}, {{ self.layer.bounds.2 }}]
]);
{% endif %}

{% map_data self as data %}
var data = {{ data|safe }}

L.tileLayer('https://api.mapbox.com/v4/ags.map-g13j9y5m/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWdzIiwiYSI6IjgtUzZQc0EifQ.POMKf3yBYLNl0vz1YjQFZQ').addTo(map);

function getColor(value) {
    {% for color in self.color_ramp %}
    if (value >= {{ color.min_value }} && value <= {{ color.max_value }}) {
        return '#{{ color.color }}';
    }
    {% endfor %}
}


L.geoJson(data, {
  style: function(layer) {
    return {
      color: "#000",
      weight: 1,
      fillColor: getColor(layer.properties.{{ self.expression.name }}),
      fillOpacity: 1
    };
  },
  onEachFeature: function(feature, layer) {
    layer.bindPopup(String(feature.properties.{{ self.expression.name }}));
  }
}).addTo(map);

var legend = L.control({position: 'bottomright'});

legend.onAdd = function(map) {
  var div = L.DomUtil.create('div', 'info legend');

  {% for color in self.color_ramp %}
  div.innerHTML += '<i style="background: #{{ color.color }}"></i> ' +
    '{{ color.min_value }} &ndash; {{ color.max_value }}<br>';
  {% endfor %}

  return div;
};

legend.addTo(map);
</script>
