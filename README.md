# GeoKit

## Configuration

Put this in `local.py` for local dev & testing purposes:

```
from .base import DATABASES, GEOKIT_HOSTS

GEOKIT_HOSTS.append('testserver') # django's hostname in testing mode

DATABASES['default']['TEST'] = {'NAME': your_db_name }

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': { 'class': 'logging.StreamHandler', },
    },
    'loggers': {
        'tests': {
            'level': 'INFO',
            'handlers': ['console'],
        },
    },
}

DEBUG = True
```

## Installation

Before geokit is started or tested, one needs to create a virtualenvironment
and run `pip install -r dev_requirements.txt` inside of it; `requirements.txt`
is for production while `dev_requirements.txt` also installs testing apparatus.

## Fixtures

Up-to-date fixtures can be generated by running `./manage.py generate_tables_fixtures <schema_name>` and `./manage.py generate_layers_fixtures <schema_name>`, where `<schema_name>` represents a schema that has the `cnty_24k97` layer and `cnty_24k97_data` table loaded (shapefile and csv can be found in `/projects/geokit/testdata/ca_climate`).

# Running

The `run.sh` script takes either the `hostname:port` or just `port` as an argument:

```
#!bash

./run.sh 0.0.0.0:8000
```
or
```
#!bash

./run.sh 8000
```

The `run.sh` script also creates an SSH tunnel to oka's Postgres port, so
geokit can be run on any system that can ssh to oka.ags.io

# Task queue

Geokit uses a task queue to process some of it's work asynchronously, outside the normal
request/response cycle. In order for this to work, you need at least one task queue
worker running, as well as a Redis server running on `localhost`. To start a worker,
run this command:

```
./manage.py rqworker
```

More workers may be started to allow for multiple async jobs to be run concurrently.

A template is provided for running works as systemd services. In order to use systemd, first
copy `geokit@.service.example` to `/etc/systemd/system/geokit@.service`. Then uncomment the lines
for `ExecStart` and `PIDFile` in the unit file, making sure to replace the paths with the absolute
path of your GeoKit installation. Create an empty `pidfiles/` directory in your GeoKit installation
directory. Finally, you can start and stop a worker using systemd:

```
systemctl start geokit@1.service
systemctl stop geokit@1.service
```

To start multiple workers at once, use a shell expansion:

```
systemctl start geokit@{1..5}.service
```

# Tests

Run the `py.test`-based test suite:

```
#!bash

# first make sure this is running in its own terminal or in the background:
ssh -o "ExitOnForwardFailure yes" -nNT -L 5432:localhost:5432 oka.ags.io

# to run all tests (after activating your virtualenv):
py.test --setup-db # only needed for the first run
py.test            # save a second off the runtime by leaving it off
py.test -s         # echo stdout & stderr to console instead of capturing them

# specific subsets of tests:
py.test geokit_tables                       # everything under that dir
py.test geokit_tables/tests/test_forms.py   # only the tests in this file
# just run this one named test:
py.test geokit_tables/tests/test_forms.py::test_the_thing

# for a coverage report:
py.test --cov-report term-missing --cov=APP_NAME geokit_tables
```
